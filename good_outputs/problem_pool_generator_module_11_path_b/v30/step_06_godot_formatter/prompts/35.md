# Prompt: godot_formatter
# Generated: 2026-02-19T17:38:10.898955
======================================================================

## API Parameters
- temperature: 1
- max_tokens: 16000

======================================================================

## System Prompt

### Block 1: Role
Purpose: Establishes AI role and task context
Cacheable: Yes

# ROLE & CONTEXT

You are an expert at transforming educational content schemas into Godot game engine format.

Your task: Transform interaction sequences into Godot-processable format with @type annotations and proper component structure.

----------------------------------------------------------------------

### Block 2: Reference Doc (sequence.md)
Purpose: Reference documentation
Cacheable: Yes

# REFERENCE DOCUMENTATION: sequence.md

<sequence>
# Sequence Schema

> Reference for sequence structure based on Godot SequenceSchema.

---

## Overview

A sequence represents a complete learning interaction with metadata, steps, workspace configuration, prompts, and validation.

### @type Field Usage

The `@type` field is used throughout sequence JSON to indicate the schema type for deserialization. While the GDScript may not strictly require it in all cases, **it is good practice to include @type for all objects**.

**Where to use @type:**
- Sequence level: `"@type": "Sequence"`
- Every Step: `"@type": "Step"`
- Prompts: `"@type": "Prompt"`
- Tools: `"@type": "Move"`, `"@type": "Place"`, `"@type": "Select"`, etc.
- Validators: `"@type": "LabelValidator"`, `"@type": "TickValidator"`, etc.
- Workspace elements: `"@type": "WorkspaceData"`, `"@type": "WorkspaceChoices"`
- Tangibles: `"@type": "NumLine"`, etc.
- Palette: `"@type": "Palette"`
- Stacks: `"@type": "FracLabelStack"`, `"@type": "PointStack"`
- Remediations: `"@type": "Remediation"`

**Best practice:** Always include @type when creating sequence JSON to ensure proper deserialization and type safety.

---

## Top-Level Structure

### Sequence
**Schema type**: `Sequence`

**Fields**:
- `@type` (required, string): Must be "Sequence"
- `metadata` (optional, SequenceMetadata): Learning context and mastery information
- `steps` (required, array of Step): Ordered steps in the sequence

**Example**:
```json
{
  "@type": "Sequence",
  "metadata": {
    "mastery_tier": "baseline",
    "mastery_component": "fractions",
    "mastery_verbs": ["identify"]
  },
  "steps": [...]
}
```

---

## Metadata

### SequenceMetadata
**Schema type**: `SequenceMetadata`

**Purpose**: Provides learning context and mastery tracking information.

**Fields**:
- `mastery_tier` (optional, string): Learning difficulty level
  - Valid values: support, confidence, baseline, stretch, challenge
- `mastery_component` (optional, string): Subject area or topic
- `mastery_verbs` (optional, array of strings): Learning objectives

**Example**:
```json
{
  "mastery_tier": "baseline",
  "mastery_component": "fractions",
  "mastery_verbs": ["identify", "compare"]
}
```

---

## Step Structure

### Step
**Schema type**: `Step`

**Purpose**: Represents a single interaction or moment in the learning sequence.

**Fields**:
- `@type` (required, string): Must be "Step"
- `metadata` (optional, dictionary): Additional step-level metadata
- `dialogue` (optional, string): Conversational text shown to student
- `audio_dir` (optional, string): Audio file directory path
- `workspace` (optional, Workspace): Visual elements and tangibles
- `prompt` (optional, Prompt): Student-facing question and interaction configuration
- `scene` (optional, string): Classroom scene setting
- `pool` (optional, Pool): Problem pool reference

**Example**:
```json
{
  "@type": "Step",
  "dialogue": "Look at the number line. What fraction does the point show?",
  "workspace": {...},
  "prompt": {...}
}
```

---

## Prompt Structure

### Prompt
**Schema type**: `Prompt`

**Purpose**: Defines the student-facing question, interaction tool, validation, and feedback.

**Fields**:
- `@type` (required, string): Must be "Prompt"
- `text` (required, string): The question or instruction shown to student
- `tool` (optional, Tool): Interaction tool (Move, Place, Paint, Select, Drag, etc.)
- `validator` (optional, Validator): Answer validation logic
- `choices` (optional, WorkspaceChoices): MCQ options for click_choice interactions
- `palette` (optional, Palette): Draggable items for drag interactions
- `remediations` (optional, array of Remediation): Incorrect answer feedback
- `on_correct` (optional, Step): Step to show on correct answer

**Example**:
```json
{
  "@type": "Prompt",
  "text": "What fraction does this point show?",
  "tool": {
    "@type": "Move"
  },
  "validator": {...},
  "choices": {
    "options": ["1/3", "2/3", "3/3"]
  }
}
```

**Note**: When `tool` is a `Move` (Drag) tool, palette information can be specified either in the tool itself or at the prompt level. The schema automatically migrates prompt-level palette to the Move tool during deserialization.

---

## Workspace Elements

### WorkspaceChoices
**Schema type**: `WorkspaceChoices`

**Purpose**: Multiple choice options for click_choice interaction tool.

**Fields**:
- `@type` (required, string): Must be "WorkspaceChoices"
- `allow_multiple` (optional, boolean): Whether multiple options can be selected. Default: false
- `options` (required, array of strings): The choice options

**Example**:
```json
{
  "@type": "WorkspaceChoices",
  "allow_multiple": false,
  "options": ["1/4", "2/4", "3/4", "4/4"]
}
```

**Usage**:
- For single-answer MCQ: Omit `allow_multiple` or set to `false`
- For multi-answer MCQ: Set `allow_multiple` to `true`
- Serializes to `null` if options array is empty

---

### Palette
**Schema type**: `Palette`

**Purpose**: Contains draggable items (labels, points, etc.) for drag interactions.

**Fields**:
- `stacks` (required, array of PartStack): Draggable items available in the palette

**Stacks can be**:
- `FracLabelStack`: Fraction labels with quantity
- `PointStack`: Points with quantity

**Example**:
```json
{
  "@type": "Palette",
  "stacks": [
    {
      "@type": "FracLabelStack",
      "label": "1/4",
      "quantity": 2
    },
    {
      "@type": "FracLabelStack",
      "label": "2/4"
    }
  ]
}
```

**Usage Notes**:
- Labels can only be dragged to pre-placed tick marks with `is_read_only: false` (default)
- Non-interactable tick marks (endpoints, pre-labeled ticks) should be marked `is_read_only: true`
- Quantity defaults to 1 if not specified

---

### FracLabelStack
**Schema type**: `FracLabelStack`

**Purpose**: A stack of draggable fraction labels.

**Fields**:
- `@type` (required, string): Must be "FracLabelStack"
- `label` (required, fraction): The fraction label (e.g., "1/4")
- `quantity` (optional, integer): How many labels are available. Default: 1
- `capacity` (optional, integer): Advanced - maximum capacity. Rarely used. Default: same as quantity

**Example**:
```json
{
  "@type": "FracLabelStack",
  "label": "3/4",
  "quantity": 2
}
```

**Serialization**: Omits `quantity` if 1, omits `capacity` if equal to quantity

---

### PointStack
**Schema type**: `PointStack`

**Purpose**: A stack of draggable points.

**Fields**:
- `@type` (required, string): Must be "PointStack"
- `quantity` (optional, integer): How many points are available. Default: -1 (unlimited)
- `capacity` (optional, integer): Advanced - maximum capacity. Rarely used. Default: -1 (unlimited)

**Example**:
```json
{
  "@type": "PointStack",
  "quantity": 3
}
```

**Serialization**: Omits fields if -1 (unlimited) or if capacity equals quantity

---

## Remediation

### Remediation
**Schema type**: `Remediation`

**Purpose**: Provides feedback and guidance for incorrect answers.

**Fields**:
- `@type` (required, string): Must be "Remediation"
- `id` (required, string): Unique identifier for this remediation
- `step` (required, Step): Partial step containing feedback dialogue or guidance

**Example**:
```json
{
  "@type": "Remediation",
  "id": "incorrect_third",
  "step": {
    "@type": "Step",
    "dialogue": "That's actually one-third. Two-thirds is further along the line."
  }
}
```

---

## Common Patterns

### MCQ Question with Single Answer
```json
{
  "@type": "Step",
  "dialogue": "What fraction does the point represent?",
  "prompt": {
    "@type": "Prompt",
    "text": "What fraction does this point show?",
    "choices": {
      "@type": "WorkspaceChoices",
      "options": ["1/3", "2/3", "3/3"]
    }
  }
}
```

### MCQ Question with Multiple Answers
```json
{
  "@type": "Step",
  "prompt": {
    "@type": "Prompt",
    "text": "Select all equivalent fractions to 1/2.",
    "choices": {
      "@type": "WorkspaceChoices",
      "allow_multiple": true,
      "options": ["2/4", "3/6", "1/3", "4/8"]
    }
  }
}
```

### Drag Label Question
```json
{
  "@type": "Step",
  "dialogue": "Let's label the tick marks on this number line.",
  "prompt": {
    "@type": "Prompt",
    "text": "Drag the correct label to the marked tick.",
    "tool": {
      "@type": "Move",
      "mode": "frac_labels",
      "palette": {
        "@type": "Palette",
        "stacks": [
          {"@type": "FracLabelStack", "label": "1/4"},
          {"@type": "FracLabelStack", "label": "2/4"},
          {"@type": "FracLabelStack", "label": "3/4"}
        ]
      }
    }
  }
}
```

### Point Placement Question with Limited Points
```json
{
  "@type": "Step",
  "dialogue": "Place three points on the number line.",
  "prompt": {
    "@type": "Prompt",
    "text": "Place points at 1/4, 2/4, and 3/4.",
    "tool": {
      "@type": "Move",
      "mode": "points",
      "palette": {
        "@type": "Palette",
        "stacks": [
          {"@type": "PointStack", "quantity": 3}
        ]
      }
    }
  }
}
```

### Point Placement Question with Unlimited Points
```json
{
  "@type": "Step",
  "dialogue": "Place points on the number line.",
  "prompt": {
    "@type": "Prompt",
    "text": "Place a point at 2/3.",
    "tool": {
      "@type": "Move",
      "mode": "points",
      "palette": {
        "@type": "Palette",
        "stacks": [
          {"@type": "PointStack"}
        ]
      }
    }
  }
}
```

### Drag with Multiple Label Types
```json
{
  "@type": "Step",
  "prompt": {
    "@type": "Prompt",
    "text": "Label all the tick marks.",
    "tool": {
      "@type": "Move",
      "mode": "frac_labels",
      "palette": {
        "@type": "Palette",
        "stacks": [
          {"@type": "FracLabelStack", "label": "1/4", "quantity": 2},
          {"@type": "FracLabelStack", "label": "2/4"},
          {"@type": "FracLabelStack", "label": "3/4", "quantity": 2}
        ]
      }
    }
  }
}
```

</sequence>

----------------------------------------------------------------------

### Block 3: Reference Doc (tools.md)
Purpose: Reference documentation
Cacheable: Yes

# REFERENCE DOCUMENTATION: tools.md

<tools>
# Interaction Tools

> Reference for available student interaction tools based on Godot ToolSchema.

---

## Tool Types

### move
**Schema type**: `Move`

**Purpose**: Student moves/places points or fraction labels on tick marks of a number line.

**Fields**:
- `mode` (required, string): Interaction mode - "points" for placing points, "frac_labels" for dragging fraction labels
- `allow_multiple` (optional, boolean): Whether the student can place/drag more than one item. Default: `true`
  - `true` — student can place/drag as many items as the palette allows (controlled by stack quantity)
  - `false` — student can only place/drag one item; placing a second replaces the first
- `palette` (optional, Palette object): Available items to drag (required when mode is "frac_labels"). See [Palette documentation](sequence.md#palette) for full details.

**Example (points mode)**:
```json
{
  "@type": "Move",
  "mode": "points"
}
```

**Example (fraction labels mode)**:
```json
{
  "@type": "Move",
  "mode": "frac_labels",
  "palette": {
    "@type": "Palette",
    "stacks": [
      {"@type": "FracLabelStack", "label": "1/3", "quantity": 2},
      {"@type": "FracLabelStack", "label": "2/3"}
    ]
  }
}
```

**Example (point placement with limited quantity)**:
```json
{
  "@type": "Move",
  "mode": "points",
  "palette": {
    "@type": "Palette",
    "stacks": [
      {"@type": "PointStack", "quantity": 3}
    ]
  }
}
```

---

### place
**Schema type**: `Place`

**Purpose**: Student places tick marks to partition/divide a number line (cutting task).

**Fields**:
- `lcm` (required, integer): Least common multiple for tick calculations
- `is_single` (optional, boolean): Whether student can place only one tick. Default: false
- `bounds` (optional, array of fractions): Valid range for placement (e.g., `["0", "1"]`)

**Example**:
```json
{
  "@type": "Place",
  "lcm": 12,
  "is_single": true,
  "bounds": ["0", "1"]
}
```

---

### paint
**Schema type**: `Paint`

**Purpose**: Student shades/paints sections of shapes or number line intervals.

**Fields**:
- `is_single` (optional, boolean): Whether only one section can be painted at a time. Default: false

**Example**:
```json
{
  "@type": "Paint",
  "is_single": false
}
```

---

### select
**Schema type**: `Select`

**Purpose**: Student selects tangible(s) from workspace.

**Fields**:
- `is_single` (optional, boolean): Whether only one tangible can be selected. Default: true

**Example**:
```json
{
  "@type": "Select",
  "is_single": true
}
```

---

### comp_frame
**Schema type**: `CompFrame`

**Purpose**: Composition frame tool.

**Fields**: None

**Example**:
```json
{
  "@type": "CompFrame"
}
```

---

### highlight
**Schema type**: `Highlight`

**Purpose**: Student highlights elements.

**Fields**: None

**Example**:
```json
{
  "@type": "Highlight"
}
```

---

### cut_grid
**Schema type**: `CutGrid`

**Purpose**: Grid cutting tool for dividing 2D grids.

**Fields**: None

**Example**:
```json
{
  "@type": "CutGrid"
}
```

---

## Tool Selection Guide for Module 4 Path B

**Place points on existing ticks**:
- Tool: `Move` with `mode: "points"`
- Use for: Student places points at specific tick positions
- Validated with: `PointValidator`

**Drag fraction labels onto ticks**:
- Tool: `Move` with `mode: "frac_labels"` and `palette`
- Use for: Student drags labels from palette onto ticks
- Requires palette with FracLabelStack items (see [Palette docs](sequence.md#palette))
- Validated with: `LabelValidator`

**Partition/divide number line (create new ticks)**:
- Tool: `Place`
- Use for: Student divides line into equal intervals
- Validated with: `TickValidator`

**Select one number line**:
- Tool: `Select`
- Configuration: Single selection
- Validated with: `SelectionValidator`

**Select multiple number lines**:
- Tool: `Select` with `is_single: false`
- Validated with: `SelectionValidator`

**Paint/shade intervals**:
- Tool: `Paint`
- Configuration: Multi or single
- Validated with: `ShadedValidator` or `ShadedPartsValidator`

</tools>

----------------------------------------------------------------------

### Block 4: Reference Doc (validators.md)
Purpose: Reference documentation
Cacheable: Yes

# REFERENCE DOCUMENTATION: validators.md

<validators>
# Validators

> Reference for validator types based on Godot ValidatorSchema.

---

## Validator Types

### ShadedValidator
**Schema type**: `ShadedValidator`

**Purpose**: Validates that shapes/intervals are shaded to match a target fraction.

**Fields**:
- `answer` (Fraction): The target fraction that should be shaded (e.g., `"3/4"`)

**Example**:
```json
{
  "@type": "ShadedValidator",
  "answer": "3/4"
}
```

---

### ShadedPartsValidator
**Schema type**: `ShadedPartsValidator`

**Purpose**: Validates that an exact count of parts are shaded (integer validation).

**Fields**:
- `answer` (optional, integer, min: 0): Number of parts that should be shaded

**Example**:
```json
{
  "@type": "ShadedPartsValidator",
  "answer": 3
}
```

---

### SameShadedValidator
**Schema type**: `SameShadedValidator`

**Purpose**: Validates that multiple tangibles have the same amount shaded (comparison validation).

**Fields**: None

**Example**:
```json
{
  "@type": "SameShadedValidator"
}
```

---

### SelectionValidator
**Schema type**: `SelectionValidator`

**Purpose**: Validates that correct tangible(s) are selected from workspace.

**Fields**:
- `answer` (integer OR array of integers): Index/indices of correct tangible(s)
  - Single selection: `0` or `[0]`
  - Multiple selection: `[0, 2]`

**Index Counting**:
- Indices count **ALL tangibles in the tangibles array** (0-based)
- This **includes read-only tangibles** (reference bars, etc.)
- Example workspace:
  ```json
  "tangibles": [
    { "@type": "NumLine", "is_read_only": true, "intervals": "1/4" },  // Index 0
    { "@type": "NumLine", "intervals": "1/2" },                        // Index 1
    { "@type": "NumLine", "intervals": "1/3" },                        // Index 2
    { "@type": "NumLine", "intervals": "1/6" }                         // Index 3
  ]
  ```
  - To select the "1/2" bar: `answer: 1`
  - To select the "1/3" bar: `answer: 2`
  - To select both "1/2" and "1/6": `answer: [1, 3]`

**Examples**:

Single selection:
```json
{
  "@type": "SelectionValidator",
  "answer": 0
}
```

Multiple selection:
```json
{
  "@type": "SelectionValidator",
  "answer": [0, 2]
}
```

---

### MultipleChoiceValidator
**Schema type**: `MultipleChoiceValidator`

**Purpose**: Validates selection from multiple choice options.

**Fields**:
- `answer` (array of integers, min: 0): Indices of correct choice(s)
  - 0-based indexing
  - Can contain multiple indices for multi-select questions

**Example**:
```json
{
  "@type": "MultipleChoiceValidator",
  "answer": [1]
}
```

**Conversion notes**:
- Choice id "a" → index `[0]`
- Choice id "b" → index `[1]`
- Choice id "c" → index `[2]`

---

### TickValidator
**Schema type**: `TickValidator`

**Purpose**: Validates the fraction size of parts (e.g., after cutting/dividing) and tick placement on number lines.

**Fields**:
- `answer` (Fraction OR array of Fractions): Expected tick position(s) or fraction size of parts

**Answer Format**:
- **Shorthand (string)**: A single fraction like `"1/3"` validates all tick marks for that denominator (scales to any range: 0-1, 0-2, etc.)
  - `"1/3"` → validates all ticks for thirds (1/3, 2/3 on 0-1; or 1/3, 2/3, 4/3, 5/3 on 0-2)
  - `"1/4"` → validates all ticks for fourths
  - `"1/8"` → validates all ticks for eighths
- **Array (explicit)**: Validates specific tick positions; MUST include endpoints
  - `["0", "1/3", "2/3", "1"]` for thirds
  - `["0", "1/4", "2/4", "3/4", "1"]` for fourths

**Examples**:

Shorthand for thirds (validates all ticks for thirds):
```json
{
  "@type": "TickValidator",
  "answer": "1/3"
}
```

Explicit array (validates these specific ticks):
```json
{
  "@type": "TickValidator",
  "answer": ["0", "1/3", "2/3", "1"]
}
```

**Note**: A single position like `"2/3"` is not meaningful as shorthand. Use `"1/3"` to validate all thirds, or use explicit array format.

---

### PointValidator
**Schema type**: `PointValidator`

**Purpose**: Validates that points are placed at correct positions on number line. Used with Move tool (mode="points").

**Fields**:
- `answer` (array of Fractions): Expected point positions

**Example**:
```json
{
  "@type": "PointValidator",
  "answer": ["2/7"]
}
```

---

### LabelValidator
**Schema type**: `LabelValidator`

**Purpose**: Validates dragged fraction labels placed on number line ticks. Used with Move tool (mode="frac_labels" with palette).

**Fields**:
- `answer` (array of Fractions): The labels that should be dragged from the palette to correct positions

**Example**:
```json
{
  "@type": "LabelValidator",
  "answer": ["1/4"]
}
```

**Important**: Answer array should ONLY include the labels being validated from the palette, NOT all tick marks or pre-existing labels.
- If palette has `["1/6"]` → answer: `["1/6"]`
- If palette has `["1/3", "2/3"]` → answer: `["1/3", "2/3"]`
- Do NOT include all possible tick positions

---

## Validator Selection Guide

**For Move tool (placing points, mode="points")**:
- Use: `PointValidator`
- Answer format: `["2/7"]` (array of fractions)

**For Move tool (dragging labels, mode="frac_labels" with palette)**:
- Use: `LabelValidator`
- Answer format: Labels from palette `["1/3"]` or `["1/3", "2/3"]`

**For Place tool (placing ticks)**:
- Use: `TickValidator`
- Answer format (shorthand): `"1/3"` (validates all ticks for thirds, scales to any range)
- Answer format (explicit): `["0", "1/3", "2/3", "1"]` (validates specific ticks, must include endpoints)

**For Select tool (single)**:
- Use: `SelectionValidator`
- Answer format: `0` or `[0]`

**For Select tool (multi)**:
- Use: `SelectionValidator`
- Answer format: `[0, 2]`

**For MCQ (choices)**:
- Use: `MultipleChoiceValidator`
- Answer format: `[1]`

**For Paint tool (proportion)**:
- Use: `ShadedValidator`
- Answer format: `"3/4"`

**For Paint tool (count)**:
- Use: `ShadedPartsValidator`
- Answer format: `3`

---

## Answer Format Reference

### Fraction Format
Fractions are specified as strings:
- Format: `"numerator/denominator"` (e.g., `"2/3"`, `"1/4"`)
- Whole numbers: `"3"` or `"3/1"`
- Always use strings, not numeric types

### Index Format
Tangible and choice indices are 0-based integers:
- First item: `0`
- Second item: `1`
- Third item: `2`

### Single vs Array
- `SelectionValidator` accepts both single integer and array
- `MultipleChoiceValidator` requires array (even for single choice)
- `TickValidator` accepts both single fraction and array
- `LabelValidator` requires array


</validators>

----------------------------------------------------------------------

### Block 5: Reference Doc (workspace.md)
Purpose: Reference documentation
Cacheable: Yes

# REFERENCE DOCUMENTATION: workspace.md

<workspace>
# Workspace Structure

> Reference for workspace tangibles based on Godot WorkspaceSchema.

---

## Workspace Structure

**Schema type**: `WorkspaceData`

**Fields**:
- `tangibles` (array): Array of tangible objects (NumLine, Vocab, Benchmark, MathExpression, Grid)
- `shuffle_tangibles` (boolean): Randomly shuffle the order of tangibles on load. **Auto-managed** — set automatically by the pipeline when the prompt tool is `Select` and no tangibles are read-only. Do not set manually.

**Example**:
```json
{
  "@type": "WorkspaceData",
  "tangibles": [
    {"@type": "NumLine", ...}
  ]
}
```

---

## Common Tangible Fields

All tangibles support these optional layout fields:

- `@col` (integer): Column position in layout
- `@layout` (string): Layout mode - `"underlay"`, `"default"`, or `"overlay"`

---

## Tangible Types

### NumLine (Number Line)
**Schema type**: `NumLine`

**Purpose**: 1D visual representation showing intervals, tick marks, and fraction positions.

**Required Fields**:
- Must have either `ticks` OR `intervals` (but not both)

**Optional Fields**:

**visual** (string): Visual representation type. Default: `"line"`
- Valid values: `"bar"`, `"pie"`, `"line"`, `"equation"`, `"bar_sm"`, `"composite_bar_equation"`, `"polygon"`, `"polygon_flat"`, `"mini_bar"`

**lcm** (integer): Least common multiple for calculations. Default: `24`

**range** (array of 2 integers): Start and end bounds. Default: `[0, 1]`

**ticks** (Fraction or array of Fractions): Tick mark positions

**intervals** (Fraction or array of Fractions): Interval sizes (auto-generates ticks)

**points** (array of Fractions): Highlighted point positions. Must be fraction strings like "1/4", "2/3", not floats. Default: `[]`

**labels** (boolean or array of Fractions): Which ticks show fraction labels (positioned below number line). INTERACTIVE - can be dragged with Move tool (mode="frac_labels"). Default: `true`

**alt_labels** (boolean or array of Fractions): Alternative labels for ticks (positioned on top of number line). NON-INTERACTIVE - cannot be dragged into or out of. Used for fixed reference labels. Default: `false`

**invert_labels** (boolean): Flips the position of labels and alt_labels. When `true`, labels appear on top (interactive) and alt_labels appear below (non-interactive). Use this to allow dragging labels to the top position. Default: `false`

**ticks_is_read_only** (boolean or array of Fractions): Make ticks non-interactive. Default: `false`
- Valid: `true` (all ticks), `false` (no ticks), or `["0", "1/3", "2/3"]` (specific fraction strings)
- INVALID: `[true, true, false, ...]` (arrays of booleans are not supported)

**intervals_is_read_only** (boolean or array of integers): Make intervals non-interactive. Default: `false`
- Valid: `true` (all intervals), `false` (no intervals), or `[0, 1, 2]` (specific interval indices)
- INVALID: `[true, false, true, ...]` (arrays of booleans are not supported)

**is_read_only** (boolean): Make entire number line read-only. Default: `false`

**intervals_is_shaded** (boolean or array of integers): Which intervals are shaded. Default: `false`
- Boolean: `true` shades all intervals, `false` shades none
- Array of indices: specific intervals to shade (e.g., `[0, 1, 2, 3]` shades the first four)

**Important**: Cannot specify both `ticks` and `intervals` - use one or the other

**Tick Specification**:

**IMPORTANT**: Ticks must be specified as **fraction strings** (e.g., "1/4", "2/4"), **NOT** as float arrays (e.g., 0.25, 0.5). Floats are not supported.

Single fraction (uniform spacing):
```json
"ticks": "1/3"
// Generates: [0, "1/3", "2/3", 1] within the range
```

Array of fractions (explicit positions):
```json
"ticks": ["0", "1/3", "2/3", "1"]
// ✓ CORRECT: Fraction strings
// ✗ WRONG: [0, 0.333, 0.666, 1] - floats not supported
```

**Interval Specification**:

**IMPORTANT**: Intervals must be specified as **fraction strings**, **NOT** floats.

Single fraction (uniform intervals):
```json
"intervals": "1/4"
// Generates ticks at: [0, "1/4", "1/2", "3/4", 1]
```

Array of fractions (explicit interval sizes):
```json
"intervals": ["1/4", "1/4", "1/2"]
// Generates ticks at: [0, "1/4", "1/2", 1]
// ✓ CORRECT: Fraction strings
// ✗ WRONG: [0.25, 0.25, 0.5] - floats not supported
```

**Labels Specification**:

**labels** (interactive, positioned below by default):

Boolean (all or none):
```json
"labels": true   // All ticks labeled below (can be dragged)
"labels": false  // No ticks labeled
```

Array (specific ticks to label - must match tick fraction strings):
```json
"labels": ["0", "1/2", "1"]  // Only these ticks labeled below
// ✓ CORRECT: Fraction strings matching tick positions
// ✗ WRONG: [0, 0.5, 1] - floats not supported
```

**alt_labels** (non-interactive, positioned on top by default):

Same format as labels but NON-DRAGGABLE, displays on top:
```json
"alt_labels": true              // All ticks labeled on top (fixed, cannot drag)
"alt_labels": ["0", "1"]        // Only these ticks labeled on top (fixed)
```

**invert_labels** (swaps positions):

```json
"invert_labels": false  // Default: labels below (draggable), alt_labels on top (fixed)
"invert_labels": true   // Inverted: labels on top (draggable), alt_labels below (fixed)
```

**Use case for invert_labels:** When you want students to drag labels to the TOP position, set `"invert_labels": true`. This places the interactive labels on top while keeping fixed reference labels below.

**Note:** Both `labels` and `alt_labels` can be used simultaneously. Only `labels` can be dragged; `alt_labels` are always fixed display-only.

**Example - Basic Number Line**:
```json
{
  "@type": "NumLine",
  "visual": "line",
  "range": [0, 1],
  "ticks": "1/3",
  "points": ["2/3"],
  "labels": ["0", "1"],
  "lcm": 12
}
```

**Example - Number Line with Intervals**:
```json
{
  "@type": "NumLine",
  "visual": "bar",
  "range": [0, 1],
  "intervals": "1/4",
  "intervals_is_shaded": [0, 2],
  "lcm": 24
}
```

**Example - Draggable Labels with Fixed Reference Labels**:
```json
{
  "@type": "NumLine",
  "visual": "line",
  "range": [0, 1],
  "ticks": "1/4",
  "labels": false,           // No draggable labels initially (student will drag them)
  "alt_labels": ["0", "1"],  // Fixed reference labels on top
  "lcm": 24
}
```

**Example - Drag Labels to Top Position**:
```json
{
  "@type": "NumLine",
  "visual": "line",
  "range": [0, 1],
  "ticks": "1/3",
  "labels": false,           // No draggable labels initially
  "alt_labels": ["0", "1"],  // Fixed labels that will appear below when inverted
  "invert_labels": true,     // Swap positions: draggable on top, fixed below
  "lcm": 12
}
```

---

### Vocab (Vocabulary Label)
**Schema type**: `Vocab`

**Purpose**: Text label or vocabulary term displayed in workspace.

**Required Fields**:
- `label` (string): The text to display

**Optional Fields**:
- `is_highlighted` (boolean): Whether label is emphasized. Default: `false`

**Example**:
```json
{
  "@type": "Vocab",
  "label": "unit fraction",
  "is_highlighted": false,
  "@col": 0,
  "@layout": "default"
}
```

---

### Benchmark
**Schema type**: `Benchmark`

**Purpose**: A vertical reference line that spans all visuals in the same column. Used to help students compare fractions against a known value (typically 1/2). Always a separate tangible — not a property of a NumLine or fraction strip.

**Optional Fields**:
- `location` (Fraction): Position of the benchmark line. Default: `"1/2"` — omit when using 1/2
- `is_label_visible` (boolean): Show a fraction label at the line position. Default: `true` — omit unless hiding
- `is_visible` (boolean): Show or hide the entire benchmark. Default: `true` — omit unless hiding
- `@col` (integer): Column position. Default: `0`
- `@layout` (string): Default is `"underlay"` — renders behind all bars and number lines in the same column. Omit in most cases.

**Minimal example (benchmark at 1/2 with label — most common)**:
```json
{
  "@type": "Benchmark"
}
```

**Explicit location (only needed when not 1/2)**:
```json
{
  "@type": "Benchmark",
  "location": "3/4"
}
```

**Without label**:
```json
{
  "@type": "Benchmark",
  "is_label_visible": false
}
```

**Full workspace example (benchmark with two stacked number lines)**:
```json
{
  "tangibles": [
    { "@type": "Benchmark" },
    { "@type": "NumLine", "visual": "line", "ticks": "1/4", "points": ["3/4"], "labels": ["0", "1"], "lcm": 12 },
    { "@type": "NumLine", "visual": "line", "ticks": "1/6", "points": ["1/6"], "labels": ["0", "1"], "lcm": 12 }
  ]
}
```

**Notes**:
- `@layout` defaults to `"underlay"` — the benchmark renders behind all shapes automatically. No need to set it explicitly.
- Serializer omits `location` when it equals 1/2, omits `@layout` when it equals `"underlay"`, and omits boolean fields when they equal their defaults. A benchmark at 1/2 with label visible serializes to `{}` (just the `@type`).

---

### MathExpression (Mathematical Expression)
**Schema type**: `MathExpression`

**Purpose**: Displays mathematical expressions with fractions and operators.

**Optional Fields**:
- `terms` (array): Array of Fractions or Term objects representing the expression

**Example**:
```json
{
  "@type": "MathExpression",
  "terms": ["1/4", "+", "2/4", "=", "3/4"],
  "@col": 0,
  "@layout": "default"
}
```

**Note**: Terms can be either Fraction objects or Term objects (operators, symbols, etc.). Fraction terms automatically have their labels set to visible.

---

### Grid
**Schema type**: `Grid`

**Purpose**: 2D grid representation for area models and fraction visualization.

**Optional Fields**:
- `h_lcm` (integer): Horizontal divisions (columns). Default: `8`
- `v_lcm` (integer): Vertical divisions (rows). Default: `4`

**Example**:
```json
{
  "@type": "Grid",
  "h_lcm": 8,
  "v_lcm": 4,
}
```

**Note**: Grid automatically generates parts based on h_lcm × v_lcm dimensions, with each part representing `1/(h_lcm × v_lcm)`.

---

## Fraction Format

Fractions are specified as **strings** in "numerator/denominator" format:

**Valid formats**:
- `"1/3"` - proper fraction
- `"2/3"` - proper fraction
- `"4/4"` - whole number as fraction
- `"3"` or `"1"` or `"0"` - whole numbers (equivalent to "3/1", "1/1", "0/1")

**Invalid formats** (will cause errors):
- `0.25` - float/decimal (use `"1/4"` instead)
- `[0.25, 0.5, 0.75]` - array of floats (use `["1/4", "2/4", "3/4"]` instead)
- `1/4` - unquoted (use `"1/4"` with quotes)

**Schema handling**:
- Deserializer: Parses string to `Fraction` object with `numerator` and `denominator` fields
- Serializer: Converts `Fraction` object back to string format
  - If denominator is 1: outputs `"3"` (not `"3/1"`)
  - Otherwise: outputs `"3/4"` format

---

## Field Behaviors

### Boolean vs Array Fields

Several fields accept both boolean and array values:

**Boolean mode** (applies to all):
```json
"labels": true          // All ticks labeled
"labels": false         // No ticks labeled
"ticks_is_read_only": true   // All ticks read-only
```

**Array mode** (applies to specific items):
```json
"labels": ["0", "1"]              // Only these ticks labeled
"ticks_is_read_only": ["1/3", "2/3"]  // Only these ticks read-only
"intervals_is_shaded": [0, 2]         // Only intervals at index 0 and 2 shaded
```

### Read-Only Behavior

Multiple levels of read-only controls:

1. **Entire tangible**: `is_read_only: true` - Nothing can be modified
2. **Specific ticks**: `ticks_is_read_only: ["1/3"]` - Only certain ticks locked
3. **Specific intervals**: `intervals_is_read_only: [0, 2]` - Only certain sections locked

---

## Serialization/Deserialization Notes

The schema handles conversion between JSON and internal Godot objects:

**Deserialization** (JSON → Godot):
- String fractions → `Fraction` objects
- Single fraction → Array of ticks/intervals
- Boolean flags → Configured internal state

**Serialization** (Godot → JSON):
- Omits default values for cleaner JSON
- Converts uniform ticks back to single fraction
- Converts boolean arrays back to boolean if all true/false
- Example: All ticks labeled → `"labels": true` instead of array

**Validation errors** are returned for:
- Using deprecated GRID visual (value 2)
- Specifying both `ticks` and `intervals`
- Invalid fraction formats
- References to non-existent ticks

---

## Layout System

Tangibles can be positioned using layout fields:

**Column positioning**:
```json
"@col": 0  // First column
"@col": 1  // Second column
```

**Layer positioning**:
```json
"@layout": "underlay"   // Behind other elements
"@layout": "default"    // Normal layer
"@layout": "overlay"    // In front of other elements
```

**Typical usage**:
- Benchmarks: `@layout: "underlay"`
- Main tangibles: `@layout: "default"` (or omit)
- Highlights: `@layout: "overlay"`

---

## Module 4 Path B Usage

For number line focused activities:

**Primary tangible**: `NumLine` with `visual: "line"`

**Common patterns**:

**Single number line with point**:
```json
{
  "@type": "NumLine",
  "visual": "line",
  "ticks": "1/3",
  "points": ["2/3"],
  "labels": ["0", "1"]
}
```

**Comparison set (multiple lines)**:
```json
{
  "tangibles": [
    {"@type": "NumLine", "ticks": "1/3", ...},
    {"@type": "NumLine", "ticks": "1/4", ...}
  ]
}
```

**Benchmark reference**:
```json
{
  "tangibles": [
    {"@type": "Benchmark", "location": "1/2", "@layout": "underlay"},
    {"@type": "NumLine", ...}
  ]
}
```

**Not typically used in Module 4 Path B**:
- Interval shading (focuses on tick positions)

</workspace>

----------------------------------------------------------------------

### Block 6: Instructions
Purpose: Step-by-step task instructions
Cacheable: Yes

# TASK INSTRUCTIONS


## TASK

Transform interaction sequence into Godot Sequence format.

You will receive ONE sequence with metadata and a `steps` array (may contain single or multiple steps). Transform it into ONE Godot Sequence with:
- Metadata at the top level
- All steps in the `steps` array
- Proper @type annotations throughout

**MULTI-STEP WORKSPACE HANDLING (CRITICAL):**
- **Step 1**: Input workspace is array → Output normally as WorkspaceData with tangibles
- **Step 2+**: Check input workspace structure:
  - If input has `{"inherited": true, "tangibles": [...]}` → Omit workspace from output (inherits from the most recent step that had a workspace)
  - If input has `{"inherited": false, "tangibles": [...]}` → Output workspace normally (new/reset workspace). This step becomes the new reference — any subsequent steps with `inherited: true` will inherit from THIS step's workspace, not from an earlier step.
  - If input is array → Output workspace normally (backward compatibility)

**CRITICAL: Consult <sequence> for the complete Godot sequence structure. Every element you generate (Sequence, Step, Prompt, WorkspaceChoices, Palette, Remediation) must conform exactly to the schema specifications in sequence.md.**

Refer to documentation for complete specifications:
- **sequence.md** - Complete sequence structure with @type usage, Step, Prompt, WorkspaceChoices, Palette, Remediation schemas
- **tools.md** - Tool types (Move, Place, Drag, Select, Paint, etc.)
- **validators.md** - Validator types and answer formats
- **workspace.md** - Tangible types (NumLine, FracShape, Vocab, etc.)

## KEY TRANSFORMATIONS

### 1. Add @type Annotations
Consult <sequence> for @type field usage across all objects. Every object requires a @type field for proper deserialization.

### 2. Metadata Extraction
Move sequence-level fields into metadata object:
```json
"metadata": {
  "@type": "SequenceMetadata",
  "problem_id": 123,
  "template_id": "4008",
  "template_skill": "Description of the skill being practiced",
  "identifiers": ["2/3"],
  "mastery_tier": "BASELINE",  // Keep original: SUPPORT, CONFIDENCE, BASELINE, STRETCH, CHALLENGE
  "mastery_verb": "IDENTIFY",
  "telemetry_data": {
    "mastery_skill": "Place unit fraction on 0-1 number line",  // from template_ref
    "cognitive_verb": "CREATE",  // from template_ref
    "mastery_skill_id": "M4-01",  // from template_ref
    "tier": "baseline",  // from input mastery_tier variable
    "non_curriculum_skills": ["click_accuracy"],  // determined by interaction_tool (place_point)
    "misconception_id": [],
    "misconception_tag": []
  }
}
```

**Identifiers Array Format:**
- Copy the fractions array directly to identifiers
- Example: If input has `fractions: ["2/3"]`, output is `identifiers: ["2/3"]`
- Multiple fractions: `fractions: ["2/3", "1/4"]` → `identifiers: ["2/3", "1/4"]`

### 3. Tool Mapping
**CRITICAL: You MUST strictly follow ALL tool schemas defined in <tools>. Every tool must use the exact structure, @type, and required fields specified in tools.md. Validate your output against tools.md before finalizing.**

Map `interaction_tool` to Godot tool @type (refer to <tools> for complete schema):

**Point Placement:**
- `place_point` → Move with mode="points" and palette with PointStack
  - For unlimited points: PointStack with no quantity field (defaults to -1)
    ```json
    {
      "@type": "Move",
      "mode": "points",
      "palette": {
        "@type": "Palette",
        "stacks": [{"@type": "PointStack"}]
      }
    }
    ```
  - For limited points: PointStack with specific quantity
    ```json
    {
      "@type": "Move",
      "mode": "points",
      "palette": {
        "@type": "Palette",
        "stacks": [{"@type": "PointStack", "quantity": 3}]
      }
    }
    ```

**Label Dragging:**
- `drag_label` → Move with mode="frac_labels" and palette with FracLabelStack (ALWAYS required)
  ```json
  {
    "@type": "Move",
    "mode": "frac_labels",
    "palette": {
      "@type": "Palette",
      "stacks": [
        {"@type": "FracLabelStack", "label": "1/4"}
      ]
    }
  }
  ```

**Other Tools:**
- `click_choice` → No tool (single-choice MCQ uses choices with allow_multiple: false)
- `multi_click_choice` → No tool (multiple-choice MCQ uses choices with allow_multiple: true)
- `select` → Select (is_single: true)
- `multi_select` → Select (is_single: false)
- `place_tick` → Place (partition number line, ALWAYS include lcm using 3× denominator rule)
- `cut_shape` → Place (divide shape, ALWAYS include lcm using 3× denominator rule)
- `shade` → Paint

### 4. Validator Mapping
Choose validator based on interaction_tool (see validators.md for complete specifications and answer formats):
- `place_point` → PointValidator
- `drag_label` → LabelValidator
- `click_choice` → MultipleChoiceValidator (with allow_multiple: false)
- `multi_click_choice` → MultipleChoiceValidator (with allow_multiple: true)
- `select` or `multi_select` → SelectionValidator
- `place_tick` or `cut_shape` → TickValidator
- `shade` → ShadedValidator or ShadedPartsValidator

**Important**:
- Move tool with mode="points" ALWAYS uses palette with PointStack (even for unlimited points)
- Move tool with mode="frac_labels" ALWAYS uses palette with FracLabelStack
- PointStack quantity defaults to -1 (unlimited) when omitted
- FracLabelStack quantity defaults to 1 when omitted
- `click_choice` is for single-answer MCQ, `multi_click_choice` is for multiple-answer MCQ (use allow_multiple: true)
- `select` is for tangible selection (different use case from text-based MCQ)
- See validators.md for correct answer format for each validator type

### 4a. Non-Curriculum Skills Mapping
Determine non_curriculum_skills array based on interaction_tool and question type:

**Interaction-based skills:**
- `place_point` → ["click_accuracy"]
- `drag_label` → ["drag_drop", "fine_motor_control"]
- `click_choice` → ["click_accuracy", "reading_comprehension"]
- `multi_click_choice` → ["click_accuracy", "reading_comprehension", "multiple_selection"]
- `select` → ["click_accuracy", "visual_discrimination"]
- `multi_select` → ["click_accuracy", "visual_discrimination", "multiple_selection"]
- `place_tick` → ["click_accuracy", "spatial_reasoning"]
- `cut_shape` → ["click_accuracy", "spatial_reasoning"]
- `shade` → ["click_accuracy", "fine_motor_control"]

**Additional skills by question characteristics:**
- If workspace has 3+ tangibles for comparison → add "visual_comparison"
- If prompt mentions "count" or "how many" → add "counting"
- If question involves fractions beyond 1 → add "extended_number_line_reasoning"
- If MCQ has 4+ options → add "option_evaluation"
- If question involves application context → add "context_interpretation"

**Common non-curriculum skills:**
- click_accuracy - Ability to click/tap precisely on targets
- drag_drop - Ability to drag items to correct locations
- fine_motor_control - Precise cursor/finger control
- reading_comprehension - Understanding written instructions
- visual_discrimination - Distinguishing between similar visual elements
- visual_comparison - Comparing multiple visual representations
- spatial_reasoning - Understanding spatial relationships
- counting - Counting intervals, ticks, or spaces
- multiple_selection - Selecting multiple items correctly
- option_evaluation - Evaluating multiple choice options
- context_interpretation - Understanding story/application context
- extended_number_line_reasoning - Working with number lines beyond 1

Generate an appropriate array of 1-3 non_curriculum_skills for each question based on these mappings.

### 4b. Misconceptions Mapping
Determine misconception_id and misconception_tag arrays based on problem characteristics:

**Misconception Mappings:**

1. **equal_vs_unequal_parts** (ID: 1)
   - Problem involves identifying equal intervals vs unequal
   - Workspace shows comparison of equal/unequal partitions
   - Tags: ["Meta_Remediation", "Context_Framing_Issue"]

2. **misidentifying_the_whole** (ID: 2)
   - Multiple wholes or shapes in workspace
   - Comparison tasks with different-sized representations
   - Tags: ["Needs_DevAdapt", "Misconception_Spotlight"]

3. **numerator_denominator_as_independent** (ID: 3)
   - Identifying or placing non-unit fractions
   - Labeling tasks where numerator changes
   - Any task requiring understanding a/b relationship
   - Tags: ["Symbol_Link_Support", "Meta_Prompt"]

4. **improper_spacing_on_number_line** (ID: 4)
   - Partitioning number lines (place_tick)
   - Comparing equal vs unequal interval spacing
   - Tags: ["Meta_Remediation", "Visual_Anchor"]

5. **counting_tick_marks_instead_of_spaces** (ID: 5)
   - Counting intervals to identify denominator
   - Placing fractions by counting from zero
   - Any task emphasizing "count spaces not ticks"
   - Tags: ["Meta_Remediation", "AI_Peer_Opportunity"]

6. **reversing_numerator_and_denominator** (ID: 6)
   - Identifying fractions from points
   - Labeling tick marks with fractions
   - Reading or writing fraction notation
   - Tags: ["Symbol_Link_Support", "Needs_DevAdapt"]

7. **difficulty_recognizing_equivalence** (ID: 7)
   - Equivalent fraction tasks (2/4 = 1/2)
   - Comparing fractions with different denominators
   - Tags: ["Transfer_Thinking", "Meta_Prompt"]

8. **errors_comparing_unlike_fractions** (ID: 8)
   - Comparing fractions with different denominators
   - Ordering fractions by size
   - Tasks where "larger denominator = smaller pieces"
   - Tags: ["Benchmark_Anchor", "Meta_Remediation"]

9. **fractions_only_exist_in_shapes** (ID: 9)
   - Application contexts using number lines
   - Transfer from area models to linear models
   - Tags: ["Transfer_Thinking", "Symbol_Link_Support"]

10. **overgeneralizing_rules** (ID: 10)
    - Complex comparison or ordering tasks
    - Application problems requiring flexible thinking
    - Tags: ["Meta_Prompt", "Needs_DevAdapt"]

11. **fractions_cant_exceed_one** (ID: 11)
    - Any task involving fractions beyond 1 (numerator > denominator)
    - Extended number lines (0-2 range)
    - Tags: []

**Assignment Logic:**
- Identify 1-3 most relevant misconceptions for each question
- Include misconception_id as array of integers: [5, 11]
- Include misconception_tag as array of strings: ["counting_tick_marks_instead_of_spaces", "fractions_cant_exceed_one"]
- If no specific misconceptions apply, use empty arrays: [], []

### 5. Workspace Restructuring
Transform workspace (see workspace.md):
- Array → object with `tangibles` array
- Add `@type` to all tangibles
- Remove `id`, `type`, and `role` fields
- Move `choices` from workspace to prompt.choices
- **Reference tangibles**: If input tangible has `"role": "reference"`, set `"is_read_only": true` in output (prevents selection/modification)

### 6. NumLine Conversions
Key field changes (see workspace.md for details):
- Keep `ticks` or `intervals` as-is (schema handles both)
- Keep `labels` as-is (schema accepts array or boolean)
- Add `is_visible: true`
- Add `visual` based on structure:
  - If NumLine has `ticks` → `"visual": "line"` (number line)
  - If NumLine has `intervals` → `"visual": "bar"` (fraction strip)
- Add `lcm` based on visual type:
  - **Fraction strip** (`visual: "bar"` or `"mini_bar"`): lcm = denominator of the interval
    - 1/4 intervals → `lcm: 4` | 1/5 → `lcm: 5` | 1/6 → `lcm: 6` | 1/7 → `lcm: 7` | 1/8 → `lcm: 8` | 1/10 → `lcm: 10` | 1/12 → `lcm: 12`
  - **Number line** (`visual: "line"`): lcm depends on denominator size
    - Denominators 2–4: lcm = 3× denominator → 1/2 → `lcm: 6` | 1/3 → `lcm: 9` | 1/4 → `lcm: 12`
    - Denominators 5–8: lcm = 2× denominator → 1/5 → `lcm: 10` | 1/6 → `lcm: 12` | 1/7 → `lcm: 14` | 1/8 → `lcm: 16`
- `intervals_is_shaded` conversions:
  - If given as integer count N → expand to array `[0, 1, ..., N-1]` (shades first N intervals, the most common case where N = numerator)
  - If boolean or array of indices → pass through as-is
- `sum_is_visible`: Set `true` when the bar needs to display its fraction label beside it (e.g., comparison problems where both fractions must be named)
- `intervals_is_frac_label_visible`: Set `true` when each individual interval should show its unit fraction (e.g., "1/6" on every section)

### 6a. Benchmark Conversions
When workspace contains a benchmark tangible (`type: "benchmark"`):
- Add `@type: "Benchmark"`
- Remove `id`, `type`, `role` fields
- `location`: Keep as fraction string if not `"1/2"` — omit entirely when it is `"1/2"` (default)
- `@layout`: Defaults to `"underlay"` — omit unless different
- `is_label_visible`: Omit unless `false`
- `is_visible`: Omit unless `false`
- No `lcm`, `visual`, `ticks`, `intervals`, or any NumLine fields
- Place the Benchmark before the NumLines/bars in the tangibles array (so it renders beneath them)

**Minimal benchmark (1/2 with label — most common)**:
```json
{ "@type": "Benchmark" }
```

**Benchmark without label**:
```json
{ "@type": "Benchmark", "is_label_visible": false }
```

### 7. Answer Conversions
- Choice IDs → indices: "a"→[0], "b"→[1], "c"→[2]
- **Tangible IDs → indices (SelectionValidator)**:
  - **CRITICAL**: Indices count ALL tangibles in order (including read-only)
  - Map each tangible ID to its position in the tangibles array (0-based)
  - Example: If workspace has tangibles in order: [reference_bar, bar_a, bar_b, bar_c]
    - reference_bar (read-only) → index 0
    - bar_a → index 1
    - bar_b → index 2
    - bar_c → index 3
  - If input has `correct_answer.value: "bar_b"` → output: `answer: 2`
  - If input has `correct_answer.value: ["bar_a", "bar_c"]` → output: `answer: [1, 3]`
- Fractions: Keep as strings "2/3"

### 8. Success and Error Paths
Convert flat fields to nested structure:
- `success_path_dialogue` → `"on_correct": {"@type": "Step", "dialogue": "..."}`
- `error_path_generic` → `"remediations": [array of 3 Remediation objects]`

For error paths, transform each scaffolding level into a separate Remediation object with ids: "light", "medium", "heavy". Consult <sequence> "Remediation" section for complete schema structure.

### 9. Choices Extraction
Move choices from workspace to prompt. Consult <sequence> "WorkspaceChoices" section for complete schema structure.

### 10. Palette Structure
When interaction_tool is "drag_label", add palette with stacks. Consult <sequence> "Palette" and "FracLabelStack" sections for complete schema structure.

## EXAMPLE TRANSFORMATION

**Input (sequence with single step)**:
```json
{
  "problem_id": 49,
  "mastery_tier": "BASELINE",
  "mastery_verb": "IDENTIFY",
  "template_id": "4008",
  "fractions": ["2/3"],
  "no_of_steps": 1,
  "steps": [
    {
      "step_id": 1,
      "dialogue": "Look at the point on the number line.",
      "prompt": "What fraction does this point show?",
      "interaction_tool": "click_choice",
      "workspace": [
        {
          "id": "line_1",
          "type": "number_line",
          "range": [0, 1],
          "ticks": ["0", "1/3", "2/3", "1"],
          "points": ["2/3"],
          "labels": ["0", "1"]
        },
        {
          "type": "choices",
          "options": [
            {"id": "a", "text": "1/3"},
            {"id": "b", "text": "2/3"}
          ]
        }
      ],
      "correct_answer": {
        "value": "b",
        "context": "The point is at 2/3"
      },
      "success_path_dialogue": "Yes, that's two-thirds.",
      "error_path_generic": {
        "steps": [
          {"scaffolding_level": "light", "dialogue": "Not quite. Try again."},
          {"scaffolding_level": "medium", "dialogue": "Look at where the point is..."},
          {"scaffolding_level": "heavy", "dialogue": "The point is at 2 out of 3 parts..."}
        ]
      }
    }
  ]
}
```

**Input (sequence with multiple steps - note step 2 workspace has inherited flag)**:
```json
{
  "problem_id": 75,
  "mastery_tier": "BASELINE",
  "mastery_verb": "create",
  "template_id": "5011",
  "fractions": ["1/4", "2/4", "3/4"],
  "no_of_steps": 2,
  "steps": [
    {
      "step_id": 1,
      "dialogue": "Let's divide this number line into fourths.",
      "prompt": "Divide this line into fourths.",
      "interaction_tool": "place_tick",
      "workspace": [
        {
          "id": "line_1",
          "type": "number_line",
          "range": [0, 1],
          "ticks": [0, 1],
          "labels": [0, 1]
        }
      ],
      "correct_answer": {
        "value": ["1/4", "2/4", "3/4"],
        "context": "Three tick marks placed"
      },
      "success_path_dialogue": "Good. You made four equal parts.",
      "error_path_generic": { "steps": [...] }
    },
    {
      "step_id": 2,
      "dialogue": "Now label each tick mark.",
      "prompt": "Label each position.",
      "interaction_tool": "drag_label",
      "workspace": {
        "inherited": true,
        "tangibles": [
          {
            "id": "line_1",
            "type": "number_line",
            "range": [0, 1],
            "ticks": [0, "1/4", "2/4", "3/4", 1],
            "labels": [0, 1]
          },
          {
            "type": "palette",
            "labels": ["1/4", "2/4", "3/4"]
          }
        ]
      },
      "correct_answer": {
        "value": {"1/4": "1/4", "2/4": "2/4", "3/4": "3/4"},
        "context": "All labels placed correctly"
      },
      "success_path_dialogue": "Right. You labeled all the fourths.",
      "error_path_generic": { "steps": [...] }
    }
  ]
}
```

**Output (Godot Sequence format - NO SequencePool wrapper)**:

For single-step sequences:
```json
{
  "@type": "Sequence",
  "metadata": {
    "@type": "SequenceMetadata",
    "problem_id": 49,
    "template_id": "4008",
    "template_skill": "Student can identify fractions on number line",
    "identifiers": ["2/3"],
    "mastery_tier": "BASELINE",
    "mastery_verb": "IDENTIFY",
    "telemetry_data": {
      "mastery_skill": "Identify fractions on pre-partitioned number line",
      "cognitive_verb": "IDENTIFY",
      "mastery_skill_id": "M4-02",
      "tier": "baseline",
      "non_curriculum_skills": ["click_accuracy", "reading_comprehension"],
      "misconception_id": [3, 6],
      "misconception_tag": ["numerator_denominator_as_independent", "reversing_numerator_and_denominator"]
    }
  },
  "steps": [{
    "@type": "Step",
    "dialogue": "Look at the point on the number line.",
    "workspace": {
      "@type": "WorkspaceData",
      "tangibles": [{
        "@type": "NumLine",
        "is_visible": true,
        "visual": "line",
        "range": [0, 1],
        "ticks": "1/3",
        "points": ["2/3"],
        "labels": ["0", "1"],
        "lcm": 12
      }]
    },
    "prompt": {
      "@type": "Prompt",
      "text": "What fraction does this point show?",
      "validator": {
        "@type": "MultipleChoiceValidator",
        "answer": [1]
      },
      "choices": {
        "@type": "WorkspaceChoices",
        "allow_multiple": false,
        "options": ["1/3", "2/3"]
      },
      "remediations": [
        {
          "@type": "Remediation",
          "id": "light",
          "step": {"@type": "Step", "dialogue": "Not quite. Try again."}
        },
        {
          "@type": "Remediation",
          "id": "medium",
          "step": {"@type": "Step", "dialogue": "Look at where the point is..."}
        },
        {
          "@type": "Remediation",
          "id": "heavy",
          "step": {"@type": "Step", "dialogue": "The point is at 2 out of 3 parts..."}
        }
      ],
      "on_correct": {
        "@type": "Step",
        "dialogue": "Yes, that's two-thirds."
      }
    }
  }]
}
```

For multi-step sequences (NOTE: Step 2 does NOT have workspace field):
```json
{
  "@type": "Sequence",
  "metadata": {
    "@type": "SequenceMetadata",
    "problem_id": 75,
    "template_id": "5011",
    "template_skill": "Create and label fourths on number line",
    "identifiers": ["1/4", "2/4", "3/4"],
    "mastery_tier": "BASELINE",
    "mastery_verb": "create",
    "telemetry_data": { ... }
  },
  "steps": [
    {
      "@type": "Step",
      "dialogue": "Let's divide this number line into fourths.",
      "workspace": {
        "@type": "WorkspaceData",
        "tangibles": [{
          "@type": "NumLine",
          "is_visible": true,
          "visual": "line",
          "range": [0, 1],
          "ticks": [0, 1],
          "labels": [0, 1],
          "lcm": 12
        }]
      },
      "prompt": {
        "@type": "Prompt",
        "text": "Divide this line into fourths.",
        "tool": {
          "@type": "Place",
          "tangible_index": 0,
          "target": "ticks",
          "lcm": 12
        },
        "validator": {
          "@type": "TickValidator",
          "answer": ["1/4", "2/4", "3/4"]
        },
        "remediations": [...],
        "on_correct": {
          "@type": "Step",
          "dialogue": "Good. You made four equal parts."
        }
      }
    },
    {
      "@type": "Step",
      "dialogue": "Now label each tick mark.",
      "prompt": {
        "@type": "Prompt",
        "text": "Label each position.",
        "tool": {
          "@type": "Drag",
          "tangible_index": 0,
          "target": "labels",
          "palette": {
            "@type": "Palette",
            "stacks": [
              {"@type": "FracLabelStack", "label": "1/4"},
              {"@type": "FracLabelStack", "label": "2/4"},
              {"@type": "FracLabelStack", "label": "3/4"}
            ]
          }
        },
        "validator": {
          "@type": "LabelValidator",
          "answer": {"1/4": "1/4", "2/4": "2/4", "3/4": "3/4"}
        },
        "remediations": [...],
        "on_correct": {
          "@type": "Step",
          "dialogue": "Right. You labeled all the fourths."
        }
      }
    }
  ]
}
```

**KEY POINT**: Step 2 has no `workspace` field because its input had `inherited: true` — omitting the field signals Godot to continue using the previous workspace. Step 2 with `inherited: false` would include its own workspace, which then becomes the reference for any later steps with `inherited: true`.

**Key transformations in this example**:
1. Flat item → Sequence (no SequencePool wrapper)
2. Metadata extracted into separate object with @type
3. All objects have @type annotations
4. Workspace: array → object with tangibles array
5. NumLine: Added visual, is_visible, lcm fields
6. NumLine: ticks simplified to "1/3" (uniform spacing)
7. NumLine: labels kept as array (workspace.md allows this)
8. Choices: moved from workspace to prompt.choices
9. Choices: options simplified from objects to strings
10. Answer: "b" converted to index [1]
11. Success path: success_path_dialogue → on_correct Step
12. Error paths: error_path_generic.steps → remediations array with @type
13. Removed: id and type fields from tangibles
14. mastery_tier kept as original string value
15. non_curriculum_skills: auto-generated based on interaction_tool (click_choice → ["click_accuracy", "reading_comprehension"])
16. misconception_id and misconception_tag: auto-generated based on problem characteristics ([3, 6] for identifying fractions from points)

## IMPORTANT NOTES

- Input is ONE flat item - output is ONE Sequence (batch mode)
- DO NOT wrap output in SequencePool (that happens in a separate step)
- **Always consult documentation:**
  - <sequence> for Sequence, Step, Prompt, WorkspaceChoices, Palette, Remediation structures
  - <tools> for tool types and schemas
  - <validators> for validator types and answer formats
  - <workspace> for tangible types and properties
- Metadata must include: problem_id, template_id, template_skill, identifiers, mastery_tier, mastery_verb, telemetry_data (with all required telemetry fields)
- Telemetry data sources:
  - mastery_skill (from template.skill)
  - cognitive_verb (from template.mastery_verb)
  - mastery_skill_id (from template.skill_id)
  - tier (from input mastery_tier)
  - non_curriculum_skills (AUTO-GENERATE based on interaction_tool using the mapping in section 4a)
  - misconception_id (AUTO-GENERATE based on problem characteristics using the mapping in section 4b, array of integers)
  - misconception_tag (AUTO-GENERATE based on problem characteristics using the mapping in section 4b, array of strings)
- Remove: id, type fields from input tangibles from steps
- **Remove role field but map it**: If input has `"role": "reference"`, output `"is_read_only": true` (for select/shade/place_point/drag_label interactions)
- Convert error_path_generic.steps array to remediations array with proper structure

Return ONLY valid JSON with Godot schema structure.


----------------------------------------------------------------------

### Block 7: Output Schema
Purpose: Defines expected output structure
Cacheable: Yes
*[CACHED: {'type': 'ephemeral'}]*

# OUTPUT STRUCTURE

<output_structure>

{
  "@type": "Sequence",
  "metadata": {
    "@type": "SequenceMetadata",
    "problem_id": 1,
    "template_id": "4001",
    "template_skill": "Student can place fractions on number line",
    "identifiers": ["1/3"],
    "mastery_tier": "BASELINE",
    "mastery_verb": "IDENTIFY",
    "telemetry_data": {
      "mastery_skill": "Place unit fraction on 0-1 number line",
      "cognitive_verb": "CREATE",
      "mastery_skill_id": "M4-01",
      "tier": "baseline",
      "non_curriculum_skills": ["click_accuracy"],
      "misconception_id": [5],
      "misconception_tag": ["counting_tick_marks_instead_of_spaces"]
    }
  },
  "steps": [{
    "@type": "Step",
    "dialogue": "...",
    "workspace": {
      "@type": "WorkspaceData",
      "tangibles": [
        {
          "@type": "NumLine",
          "is_visible": true,
          "visual": "line",
          "range": [0, 1],
          "ticks": "1/3",
          "labels": ["0", "1"],
          "lcm": 9
        }
      ]
    },
    "prompt": {
      "@type": "Prompt",
      "text": "...",
      "tool": {"@type": "Place", "lcm": 9, "bounds": ["0", "1"]},
      "validator": {"@type": "TickValidator", "answer": "1/3"},
      "remediations": [],
      "on_correct": {"@type": "Step", "dialogue": "..."}
    }
  }]
}

</output_structure>

----------------------------------------------------------------------

## User Message

<input>
{
  "problem_id": 35,
  "mastery_verb": "compare",
  "no_of_steps": 1,
  "mastery_tier": "STRETCH",
  "fractions": [
    "4/5",
    "4/9"
  ],
  "template_id": "11005",
  "steps": [
    {
      "step_id": 1,
      "dialogue": "Look at these two bars. Both have four pieces shaded. Which fraction is greater?",
      "prompt": "Select the correct comparison symbol.",
      "interaction_tool": "click_choice",
      "workspace": [
        {
          "id": "bar_a",
          "type": "fraction_strip",
          "role": "student_interaction",
          "description": "Bar divided into fifths with 4 pieces shaded",
          "range": [
            0,
            1
          ],
          "intervals": "1/5",
          "shaded_intervals": 4
        },
        {
          "id": "bar_b",
          "type": "fraction_strip",
          "role": "student_interaction",
          "description": "Bar divided into ninths with 4 pieces shaded",
          "range": [
            0,
            1
          ],
          "intervals": "1/9",
          "shaded_intervals": 4
        },
        {
          "type": "choices",
          "options": [
            {
              "id": "a",
              "text": "4/5 > 4/9"
            },
            {
              "id": "b",
              "text": "4/5 = 4/9"
            },
            {
              "id": "c",
              "text": "4/5 < 4/9"
            }
          ]
        }
      ],
      "correct_answer": {
        "value": "a",
        "context": "4/5 > 4/9 because fifths are bigger pieces than ninths, so four fifths is greater than four ninths"
      },
      "success_path_dialogue": "Right. Same count, but bigger pieces win.",
      "error_path_generic": {
        "steps": [
          {
            "scaffolding_level": "light",
            "dialogue": "Not quite. Look at the size of each individual piece in the two bars."
          },
          {
            "scaffolding_level": "medium",
            "dialogue": "Let's think about this together. Both bars have 4 pieces shaded, that's true. But here's what matters - compare the size of one fifth to one ninth. When you divide something into more pieces, each piece gets smaller. So which bar has bigger pieces?"
          },
          {
            "scaffolding_level": "heavy",
            "dialogue": "Let me walk you through this comparison. Both fractions have the same numerator - 4 pieces shaded in each bar. But look closely at the denominators. Bar A is divided into 5 equal parts, and bar B is divided into 9 equal parts. When you divide the same whole into more pieces, each piece gets smaller. That means ninths are smaller than fifths. So even though we have 4 pieces shaded in both, four fifths covers more space than four ninths. The answer is 4/5 > 4/9. When numerators are the same, the fraction with the smaller denominator is greater because its pieces are bigger."
          }
        ]
      }
    }
  ]
}
</input>

======================================================================

## Prefill

{
  "@type": "Sequence",
  "metadata": {
    "@type": "SequenceMetadata",
    "problem_id": 35,
    "template_id": "11005",
    "template_skill": "Student views two bars with the same number of pieces shaded (numerator > 1, different denominators) and selects the correct comparison symbol",
    "identifiers": ["4/5", "4/9"],
    "mastery_tier": "STRETCH",
    "mastery_verb": "compare",
    "telemetry_data": {
      "mastery_skill": "Student can select the correct comparison symbol for same-numerator non-unit fractions by comparing piece sizes in bars",
      "cognitive_verb": "compare",
      "mastery_skill_id": "M11-03",
      "tier": "STRETCH",
      "non_curriculum_skills":

